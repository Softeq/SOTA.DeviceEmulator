variables:
  - name: verbosity
    value: Normal
trigger:
- master
- develop
- release/*
- hotfix/*
stages:
- stage: Build
  jobs:
  - job: BuildApplication
    displayName: Build application
    pool:
      vmImage: 'windows-2019'
    steps:
    - task: PowerShell@2
      displayName: Test and build application package
      inputs:
        filePath: "build.ps1"
        arguments: "CiBuild --Verbosity $(verbosity)"
    - task: PublishTestResults@2
      displayName: Publish test results
      inputs:
        testRunner: VSTest
        testResultsFiles: 'TestResults/**/*.trx'
        failTaskOnFailedTests: true
    - task: CopyFiles@2
      displayName: Copy artifacts
      # condition: ne(variables['Build.Reason'], 'PullRequest')
      inputs:
        contents: 'artifacts/**'
        targetFolder: $(Build.ArtifactStagingDirectory)
    - task: PublishBuildArtifacts@1
      displayName: Publish artifacts
      # condition: ne(variables['Build.Reason'], 'PullRequest')
      inputs: 
        pathtoPublish: '$(Build.ArtifactStagingDirectory)'
        artifactName: ApplicationBinaries
- stage: Release
  jobs:
    - job: ReleaseApplication
      displayName: Release application
      pool:
        vmImage: 'windows-2019'
      steps:
      - task: PowerShell@2
        displayName: Set release version
        inputs:
          filePath: "build.ps1"
          arguments: "CiSetVersion --Verbosity $(verbosity)"
      - task: DownloadBuildArtifacts@0
        displayName: Download build artifacts
        inputs:
          buildType: 'current'
          downloadType: 'single'
          artifactName: ApplicationBinaries
          downloadPath: '$(System.ArtifactsDirectory)'
      - task: UniversalPackages@0
        displayName: Publish universal package
        inputs:
          command: publish
          publishDirectory: '$(System.ArtifactsDirectory)'
          vstsFeedPublish: SOTA
          vstsFeedPackagePublish: sota-deviceemulator
          versionOption: custom
          versionPublish: '$(UniversalPackageVersion)'
          packagePublishDescription: $[format('SOTA Device Emulator ({0} channel)', ReleaseType)]